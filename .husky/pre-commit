#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# NetNynja Enterprise - Pre-commit Hook
#
# This hook runs before each commit to ensure code quality.
# It will:
# 1. Run lint-staged for TypeScript/JavaScript files
# 2. Run Python linting (if Poetry is available)
# 3. Prevent commits with security issues

echo "ðŸ” Running pre-commit checks..."

# Run lint-staged for TypeScript/JavaScript
echo "ðŸ“ Checking staged TypeScript/JavaScript files..."
npx lint-staged

# Check for debug statements in staged files
echo "ðŸ› Checking for debug statements..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check for console.log in production code (allow in tests)
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' | grep -v 'test' | grep -v 'spec' || true)
if [ -n "$JS_FILES" ]; then
    if echo "$JS_FILES" | xargs grep -l 'console\.log\|debugger' 2>/dev/null; then
        echo "âš ï¸  Warning: Found console.log or debugger statements in staged files"
        echo "   Consider removing them before committing"
        # Note: This is a warning, not blocking
    fi
fi

# Check for Python print statements in production code
PY_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' | grep -v 'test' | grep -v 'conftest' || true)
if [ -n "$PY_FILES" ]; then
    if echo "$PY_FILES" | xargs grep -l '^[^#]*\bprint(' 2>/dev/null; then
        echo "âš ï¸  Warning: Found print() statements in staged Python files"
        echo "   Consider using logging instead"
    fi
fi

# Check for common security issues
echo "ðŸ”’ Checking for security issues..."

# Check for hardcoded secrets patterns
SECRET_PATTERNS='(password|secret|api_key|apikey|token|auth).*=.*["\x27][^\s]{8,}["\x27]'
if echo "$STAGED_FILES" | xargs grep -iE "$SECRET_PATTERNS" 2>/dev/null | grep -v 'example\|sample\|test\|mock\|fake\|placeholder' | head -5; then
    echo "âš ï¸  Warning: Possible hardcoded secrets detected"
    echo "   Please review the flagged lines"
fi

# Check for .env files being committed
if echo "$STAGED_FILES" | grep -E '^\.env$|^\.env\.local$|^\.env\.production$'; then
    echo "âŒ Error: Attempting to commit .env file"
    echo "   Environment files should not be committed"
    exit 1
fi

# Check for private keys
if echo "$STAGED_FILES" | grep -E '\.pem$|\.key$|id_rsa|id_ed25519'; then
    echo "âŒ Error: Attempting to commit private key files"
    exit 1
fi

# Run Python linting if Poetry is available and Python files are staged
if [ -n "$PY_FILES" ] && command -v poetry &> /dev/null; then
    echo "ðŸ Checking staged Python files..."

    # Run ruff if available
    if poetry run python -c "import ruff" 2>/dev/null; then
        echo "   Running ruff..."
        echo "$PY_FILES" | xargs poetry run ruff check --fix --exit-zero 2>/dev/null || true
        # Re-add auto-fixed files
        echo "$PY_FILES" | xargs git add 2>/dev/null || true
    fi

    # Run black if available
    if poetry run python -c "import black" 2>/dev/null; then
        echo "   Running black..."
        echo "$PY_FILES" | xargs poetry run black --quiet 2>/dev/null || true
        # Re-add formatted files
        echo "$PY_FILES" | xargs git add 2>/dev/null || true
    fi
fi

echo "âœ… Pre-commit checks passed!"
