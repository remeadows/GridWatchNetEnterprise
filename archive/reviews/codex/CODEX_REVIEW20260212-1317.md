# CODEX Review 20260212-1317

## Executive Summary
Ship / No-Ship: **No-Ship for production**. Lab/dev appears functional, but production hardening has **P0 blockers**.
Top risks:
- Production NATS is not configured for auth/TLS (prod overlay does not switch to `nats.prod.conf`). `docker-compose.prod.yml`, `infrastructure/nats/nats.prod.conf`, `infrastructure/nats/nats.conf`
- Vault production config path mismatch and TLS disabled in config. `docker-compose.prod.yml`, `infrastructure/vault/vault-config.hcl`
- Nginx auth proxy path likely wrong and can break production login flows. `infrastructure/nginx/nginx.conf`
- SNMPv3 credential encryption format mismatch between gateway and NPM service likely breaks decryption after SEC-018. `apps/gateway/src/routes/npm/snmpv3-credentials.ts`, `apps/npm/src/npm/services/crypto.py`, `apps/npm/src/npm/collectors/snmpv3_poller.py`
- Default admin user in DB init SQL with known password hash creates production exposure if init runs. `infrastructure/postgres/init.sql`

Security posture is strong in several areas (cap_drop, non-root containers, JWT + Argon2id, structured logging, defusedxml in Python parsing), but the P0 items above block an enterprise release.

## Architecture Overview
- Deployment model: Docker Compose with production overlay. Services include `gateway`, `auth-service`, `ipam-service`, `ipam-scanner`, `npm-service`, `npm-collector`, `npm-alerts`, `stig-service`, `stig-collector`, `stig-reports`, `syslog-service`, `syslog-collector`, `syslog-forwarder`, plus infra stack (`postgres`, `redis`, `nats`, `vault`, `victoriametrics`, `prometheus`, `loki`, `grafana`, `jaeger`, `nginx`). `docker-compose.yml`, `docker-compose.prod.yml`
- Data stores: PostgreSQL schemas `shared`, `ipam`, `npm`, `stig`, `syslog`. `infrastructure/postgres/init.sql`
- Message bus: NATS JetStream for IPAM scans, STIG audits, NPM pipelines. `infrastructure/nats/nats.conf`, `apps/ipam/src/ipam/collectors/nats_handler.py`, `apps/stig/src/stig/services/audit.py`
- Auth: Auth service issues JWTs (Argon2id for passwords). Gateway validates JWT and enforces RBAC. `services/auth-service/src/routes.ts`, `packages/shared-auth/src/index.ts`, `apps/gateway/src/plugins/auth.ts`
- Secrets: Vault for SSH credentials and other secrets. `apps/stig/src/stig/services/vault.py`
- Observability: Prometheus, Loki, Grafana, Jaeger. Gateway exposes `/metrics` with IP allowlist. `infrastructure/prometheus/prometheus.yml`, `apps/gateway/src/plugins/metrics.ts`
- Trust boundaries:
  - External clients -> Nginx -> Web UI + Gateway.
  - Gateway -> auth-service, Postgres, Redis, NATS, STIG service.
  - Python services -> Postgres, NATS, Redis.
  - Collectors -> external devices via SSH/SNMP, syslog sources via UDP/TCP 514.
  - Vault is a separate secrets boundary.

## Findings by Module

### IPAM
- Purpose & boundaries: IPAM CRUD and scan orchestration in gateway (`/api/v1/ipam`) and Python service; async scans via NATS and `ipam-scanner`. `apps/gateway/src/routes/ipam/index.ts`, `apps/ipam/src/ipam/main.py`, `apps/ipam/src/ipam/collectors/nats_handler.py`
- Data inputs/outputs and schemas: CIDR networks, scan jobs, discovered addresses; stored in `ipam.*` tables. `apps/ipam/src/ipam/api/routes.py`, `infrastructure/postgres/init.sql`
- Privilege requirements and trust assumptions: `ipam-scanner` requires `NET_RAW` for ICMP; scanning assumes trusted internal network. `docker-compose.yml`
- Failure modes: NATS unavailable leads to skipped async scans; nmap missing; very large CIDRs can lead to long-running scans. `apps/ipam/src/ipam/collectors/nats_handler.py`, `apps/ipam/src/ipam/services/scanner.py`
- Attack surface summary: Scan endpoints accept CIDR; gateway uses `exec` ping; TCP connect scanning; exposure to large request sizes. `apps/gateway/src/routes/ipam/index.ts`
- Test plan (read-only): API contract tests for network CRUD, scan start, scan results; verify NATS publish/consume; verify scan size caps and concurrency.
- Observed issues: CIDR validation allows `/8` which can produce >16M hosts and overwhelm gateway worker; no explicit scan size cap or allowlist. `apps/gateway/src/routes/ipam/index.ts`
- Recommendations: Cap max host count per scan; enforce CIDR allowlist; move scans to `ipam-scanner` exclusively; add queue/backpressure per user; add audit logging on scan requests.

### NPM
- Purpose & boundaries: Device monitoring, SNMPv3 credentials, metrics, alerts; gateway handles CRUD; NPM service handles metrics; collectors poll devices. `apps/gateway/src/routes/npm/index.ts`, `apps/npm/src/npm/main.py`, `apps/npm/src/npm/collectors/snmpv3_poller.py`
- Data inputs/outputs and schemas: Device definitions, SNMPv3 credentials, metrics time series; stored in `npm.*`. `apps/npm/src/npm/api/routes.py`, `infrastructure/postgres/init.sql`
- Privilege requirements and trust assumptions: Collectors require network reachability to SNMP devices; SNMP credentials treated as sensitive.
- Failure modes: SNMP timeouts, credential decryption failures, VictoriaMetrics down; alert evaluation drift if collector unavailable.
- Attack surface summary: SNMPv3 credential endpoints, device discovery jobs, “Poll Now” operations.
- Test plan (read-only): SNMPv3 credential create/test; polling pipeline; metrics writes; alert evaluation; RBAC controls.
- Observed issues: **Encryption format mismatch** between gateway (per-record salt, 4-part format) and NPM crypto service (3-part, static salt). This likely breaks SNMPv3 polling after SEC-018. `apps/gateway/src/routes/npm/snmpv3-credentials.ts`, `apps/npm/src/npm/services/crypto.py`, `apps/npm/src/npm/collectors/snmpv3_poller.py`
- Observed issues: SNMPv3 credential list and read endpoints are not role-restricted beyond auth. `apps/gateway/src/routes/npm/snmpv3-credentials.ts`
- Recommendations: Update Python crypto to support 4-part `salt:iv:tag:cipher` format; add migration/read-path compatibility; restrict SNMPv3 credential endpoints to admin/operator; add audit log entries for credential access.

### Syslog
- Purpose & boundaries: Syslog ingestion (UDP/TCP 514), parsing, DB storage, filters, forwarding. API via gateway. `apps/syslog/src/syslog/collector.py`, `apps/gateway/src/routes/syslog/index.ts`
- Data inputs/outputs and schemas: Raw syslog messages -> parsed events stored in `syslog.events`; filters/forwarders in `syslog.filters` and `syslog.forwarders`. `infrastructure/postgres/init.sql`
- Privilege requirements and trust assumptions: `syslog-collector` needs `NET_BIND_SERVICE`; sources should be allowlisted in production.
- Failure modes: DB unavailable at startup can crash collector; heavy load drops messages; buffer cleanup errors.
- Attack surface summary: UDP/TCP 514 ingestion; filter regex patterns; forwarder output to external systems.
- Test plan (read-only): UDP/TCP ingest, parser correctness (RFC3164/5424), redaction, rate limit drops, forwarder TLS.
- Observed issues: No DB connection retry at collector startup; prior crash noted. `apps/syslog/src/syslog/collector.py`
- Observed issues: TLS default for forwarding is warning-only, not enforced for TCP. `apps/syslog/src/syslog/forwarder.py`
- Recommendations: Add exponential backoff for DB connect; enforce TLS for forwarders in production; require allowlist for syslog sources in prod; add syslog source auth token for TCP/TLS if possible.

### STIG Management
- Purpose & boundaries: STIG targets, audits, compliance, report generation; gateway proxies to STIG service; collectors run audits. `apps/gateway/src/routes/stig/index.ts`, `apps/stig/src/stig/main.py`, `apps/stig/src/stig/services/audit.py`
- Data inputs/outputs and schemas: Targets, definitions, audit jobs and results in `stig.*`; reports in file system. `apps/stig/src/stig/api/routes.py`, `infrastructure/postgres/init.sql`
- Privilege requirements and trust assumptions: SSH access to targets; Vault token access for credentials.
- Failure modes: NATS unavailable -> audits run sync; Vault unreachable -> audit fails; report output dir permission issues.
- Attack surface summary: Config file uploads, checklist imports, report downloads, SSH connections.
- Test plan (read-only): Audit lifecycle, report generation, multi-STIG assignment, config analysis.
- Observed issues: Service-to-service communication is HTTP; doc claims internal TLS. `apps/gateway/src/routes/stig/index.ts`, `CLAUDE.md`
- Recommendations: Enforce TLS between gateway and STIG service for production; add service auth between gateway and STIG service.

### SSH Credential DB
- Purpose & boundaries: Store SSH credentials for STIG audits; encrypted at rest via gateway. `apps/gateway/src/routes/stig/ssh-credentials.ts`
- Data inputs/outputs and schemas: Credential metadata and encrypted fields in `stig.ssh_credentials`.
- Privilege requirements and trust assumptions: Admin/operator can create and update; per-user scoping enforced.
- Failure modes: Missing DB table breaks credential CRUD; decrypt failures block use.
- Attack surface summary: Decrypt endpoint returns plaintext credentials to authenticated users with operator role.
- Observed issues: `stig.ssh_credentials` table creation is missing in repo (not in `init.sql`, no CREATE TABLE in migrations). `infrastructure/postgres/init.sql`, `infrastructure/postgres/migrations/008_add_ssh_credentials_sudo.sql`
- Observed issues: Decrypt endpoint is callable by admin/operator and returns plaintext; this should be service-to-service only. `apps/gateway/src/routes/stig/ssh-credentials.ts`
- Recommendations: Add base migration for `stig.ssh_credentials`; restrict decrypt endpoint to service-token or internal network; log decrypt access in audit log.

### STIG Libraries
- Purpose & boundaries: Ingest STIG ZIPs, index and search library. Gateway handles upload to DB; STIG service indexes local library directory. `apps/gateway/src/routes/stig/index.ts`, `apps/stig/src/stig/library/indexer.py`
- Data inputs/outputs and schemas: ZIP libraries and XCCDF metadata; stored in `stig.definitions` and `stig.definition_rules`.
- Privilege requirements and trust assumptions: Upload restricted to admin/operator; assumes trusted STIG content.
- Failure modes: ZIP parsing errors; large libraries cause memory pressure.
- Attack surface summary: ZIP parsing and XML parsing.
- Observed issues: Nested ZIP size limit is not enforced for inner ZIPs; potential zip-bomb vector. `apps/gateway/src/routes/stig/index.ts`
- Recommendations: Add per-entry size cap for nested zips; consolidate ingestion to Python parser with defusedxml to reduce divergence.

### Benchmark & STIG Parsing
- Purpose & boundaries: Parse XCCDF, CKL/CKLB, config analysis.
- Data inputs/outputs and schemas: XML, ZIPs, CKL/CKLB; parsed rule metadata stored in DB and used for reports.
- Privilege requirements and trust assumptions: Parsing untrusted uploads.
- Failure modes: XML parsing errors, size limits, malformed CKL/CKLB JSON.
- Attack surface summary: XML parsing and file uploads.
- Observed issues: Gateway uses `fast-xml-parser` for XCCDF parsing; Python path uses `defusedxml`. Divergent parsing paths complicate uniform hardening. `apps/gateway/src/routes/stig/index.ts`, `apps/stig/src/stig/library/parser.py`
- Recommendations: Normalize all parsing to a single hardened implementation; keep consistent size limits.

## Security Findings by Category

### AuthN/AuthZ
- RBAC enforced in gateway and Python services, but some credential endpoints are only auth-protected and not role-restricted. `apps/gateway/src/routes/npm/snmpv3-credentials.ts`
- Gateway `TRUST_PROXY` defaults to `true` and is only warned in production, not enforced. `apps/gateway/src/config.ts`

### Secrets
- Vault production config path mismatch likely breaks boot, and TLS is disabled in config. `docker-compose.prod.yml`, `infrastructure/vault/vault-config.hcl`
- Default admin user is created by DB init script; should not exist in production. `infrastructure/postgres/init.sql`

### Crypto
- AES-256-GCM with per-record salt implemented in gateway, but Python NPM crypto expects legacy format only. `apps/gateway/src/routes/npm/snmpv3-credentials.ts`, `apps/npm/src/npm/services/crypto.py`
- JWT supports RS256 in shared-auth, but services default to HS256 unless configured; confirm production key handling. `packages/shared-auth/src/index.ts`, `services/auth-service/src/config.ts`

### Input Validation and Parsing
- Zod and Pydantic broadly used; syslog ingestion has size caps and redaction. `apps/gateway/src/routes/syslog/index.ts`, `apps/syslog/src/syslog/collector.py`
- Gateway STIG library upload lacks nested ZIP size enforcement; XML parsing path differs from hardened Python parser. `apps/gateway/src/routes/stig/index.ts`

### Supply Chain
- Images are pinned; cosign signing present per docs. Remaining CVEs noted in `PROJECT_STATUS.md`. `docker-compose.yml`, `PROJECT_STATUS.md`

### Container Security
- cap_drop ALL used; non-root users in production images. `docker-compose.yml`, Dockerfiles
- Production overlay sets `read_only` on some services but not all collectors. `docker-compose.prod.yml`

### Logging and Auditability
- Auth service logs audit events to `shared.audit_log`. `services/auth-service/src/audit.ts`
- Other modules lack explicit audit logging of sensitive admin actions (e.g., credential decrypt).

### Data Protection
- SSH and SNMPv3 secrets are encrypted at rest, but decrypt endpoints are user-accessible. `apps/gateway/src/routes/stig/ssh-credentials.ts`

### Network Security
- Internal service traffic is HTTP; docs claim internal TLS. `apps/gateway/src/routes/stig/index.ts`, `CLAUDE.md`
- NATS production config with TLS exists but is not applied by prod overlay. `docker-compose.prod.yml`, `infrastructure/nats/nats.prod.conf`

### Compliance Alignment
- Strong: structured logging, role-based access, defusedxml, container capability drops.
- Gaps: production secrets bootstrap, internal TLS, default admin user in DB init, inconsistent parsing paths.

## Prioritized Remediation Plan

### P0 (Release Blockers)
- Apply NATS production config in prod overlay and enable TLS/auth. `docker-compose.prod.yml`, `infrastructure/nats/nats.prod.conf`
- Fix Vault production config path and enforce TLS. `docker-compose.prod.yml`, `infrastructure/vault/vault-config.hcl`
- Fix Nginx auth proxy path or remove the special auth location block to avoid incorrect routing. `infrastructure/nginx/nginx.conf`
- Make NPM Python crypto compatible with 4-part encrypted credentials. `apps/npm/src/npm/services/crypto.py`
- Remove default admin user creation from production init path or gate behind dev-only flag. `infrastructure/postgres/init.sql`

### P1 (High Priority)
- Restrict SNMPv3 credential endpoints to admin/operator; log access. `apps/gateway/src/routes/npm/snmpv3-credentials.ts`
- Restrict SSH decrypt endpoint to service-token or internal network; add audit log. `apps/gateway/src/routes/stig/ssh-credentials.ts`
- Enforce syslog forwarder TLS in production; treat non-TLS as error. `apps/syslog/src/syslog/forwarder.py`
- Add DB connection retry to syslog collector startup. `apps/syslog/src/syslog/collector.py`
- Add max host count for IPAM scans; enforce CIDR allowlist. `apps/gateway/src/routes/ipam/index.ts`

### P2 (Should Fix)
- Consolidate STIG parsing to a single hardened path. `apps/gateway/src/routes/stig/index.ts`, `apps/stig/src/stig/library/parser.py`
- Add explicit internal service TLS in prod (gateway -> STIG service). `docker-compose.prod.yml`
- Add audit logging for sensitive module actions (credential changes, syslog forwarder changes).
- Document backup/restore for Postgres and VictoriaMetrics, and test restore procedure.

## Verification Checklist (Post-Fix)
1. Run production config validation and ensure no missing env vars.
2. Confirm NATS TLS/auth with valid certs and credentials.
3. Confirm Vault starts with TLS and correct config path.
4. Verify Nginx auth routes map to `gateway` with correct path.
5. Create SNMPv3 credential in gateway and verify NPM collector can decrypt and poll.
6. Attempt syslog forwarder config without TLS and verify it fails in production.
7. Confirm default admin user is not created in production.
8. Run targeted tests for IPAM scan limits, STIG uploads, and syslog ingestion.

## Appendix

### Notable Files Reviewed
- `docker-compose.yml`
- `docker-compose.prod.yml`
- `infrastructure/nginx/nginx.conf`
- `infrastructure/nats/nats.conf`
- `infrastructure/nats/nats.prod.conf`
- `infrastructure/vault/vault-config.hcl`
- `infrastructure/postgres/init.sql`
- `apps/gateway/src/index.ts`
- `apps/gateway/src/config.ts`
- `apps/gateway/src/plugins/auth.ts`
- `apps/gateway/src/plugins/metrics.ts`
- `apps/gateway/src/routes/ipam/index.ts`
- `apps/gateway/src/routes/npm/index.ts`
- `apps/gateway/src/routes/npm/snmpv3-credentials.ts`
- `apps/gateway/src/routes/stig/index.ts`
- `apps/gateway/src/routes/stig/ssh-credentials.ts`
- `apps/gateway/src/routes/syslog/index.ts`
- `apps/ipam/src/ipam/main.py`
- `apps/ipam/src/ipam/collectors/nats_handler.py`
- `apps/ipam/src/ipam/services/scanner.py`
- `apps/npm/src/npm/main.py`
- `apps/npm/src/npm/collectors/snmpv3_poller.py`
- `apps/npm/src/npm/services/crypto.py`
- `apps/stig/src/stig/main.py`
- `apps/stig/src/stig/core/config.py`
- `apps/stig/src/stig/services/audit.py`
- `apps/stig/src/stig/collectors/ssh_auditor.py`
- `apps/stig/src/stig/library/parser.py`
- `apps/syslog/src/syslog/collector.py`
- `apps/syslog/src/syslog/forwarder.py`

### Commands I Would Run (Read-Only)
```bash
# Sanity: resolved compose config
docker compose -f docker-compose.yml -f docker-compose.prod.yml config

# Prod env validation
./scripts/validate-prod-env.sh

# Targeted lint / tests
npm run lint
npm run typecheck
poetry run pytest

# Security scans
scripts/security/check-alpine-openssl.ps1
trivy image --severity HIGH,CRITICAL <image>
```
